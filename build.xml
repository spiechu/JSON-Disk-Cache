<?xml version="1.0" encoding="UTF-8"?>
<project name="JSONDiskCache" default="build">

    <property name="basedir" value="${project.basedir}"/>
    <property name="build_dir" value="${basedir}/build"/>
    <property name="src_dir" value="${basedir}/src"/>
    <property name="tests_dir" value="${basedir}/tests"/>

    <target name="build" depends="prepare,unit_test"/>

    <target name="cleanup">
        <echo msg="Deleting build dir"/>
        <delete quiet="true" dir="${build_dir}"/>
    </target>

    <target name="prepare" depends="cleanup">
        <echo msg="Making build dir"/>
        <mkdir dir="${build_dir}"/>

        <echo msg="Trying to set default.timezone ini (fixes Drone.io CI)"/>
        <php expression="ini_set('date.timezone', 'Europe/Warsaw');"/>
    </target>

    <target name="unit_test" depends="prepare">
        <phpunit bootstrap="${tests_dir}/bootstrap.php" codecoverage="true">
            <formatter type="plain" usefile="false"/>
            <batchtest>
                <fileset dir="${tests_dir}">
                    <include name="*Test.php"/>
                </fileset>
            </batchtest>
        </phpunit>

        <exec passthru="true"
              command="phpunit --bootstrap ${tests_dir}/bootstrap.php --configuration phpunit.xml.dist --coverage-text --coverage-clover=${build_dir}/coverage.clover"/>
        <exec passthru="true" command="ls ${build_dir}"/>
    </target>

</project>